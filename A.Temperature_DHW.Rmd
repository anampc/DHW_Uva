---
title: "DHW estimation for Uva Island reef"
author: "Ana Palacio"
date: "April 12, 2019"
output:
  html_document:
    fig_height: 7
    fig_width: 7
    df_print: paged
    toc: yes
    code_folding: hide
editor_options:
  chunk_output_type: console
---

```{r GlobalOptoins, include=FALSE}

knitr::opts_chunk$set(echo=TRUE, message = FALSE, warning = FALSE)
                      
```

```{r Libraries}

# Libraries
  library(lubridate)
  library(tidyverse)
  library(gridExtra) 
  library(zoo)
  library(reshape2)
  library(knitr)

# Default ggplot settings
  ggthe_bw<-theme(plot.background=element_blank(),
          panel.grid.major.y = element_blank(),
          panel.grid.major.x = element_blank(),
          panel.grid.minor.x = element_blank(),
          panel.grid.minor.y = element_blank(),
          legend.box.background = element_rect(),
          panel.background =element_rect(fill = NA, color = "black")
          )+
    theme_bw()
```

# 1. Temperature data sources 

Obtain temperature data from the different sources

```{r ImportData}

#OI_SST (provided by Ruben van Hooidonk)
    Uva.OI<-read.csv("B.Temperature_data/Uva_Daily_OISST_1982-2016.csv",header = T)
    Uva.OI$Date<-as.Date(Uva.OI$Date, format="%Y-%m-%d")

#InSitu (provided by Tyler Smith)
    Uva.InSitu<-read.csv("B.Temperature_data/Uva_Daily_InSitu_1997-2018.csv", header = T)
    Uva.InSitu$Date<-as.Date(Uva.InSitu$Date, format="%Y-%m-%d")

# CRW-5km SST (provided by Ruben van Hooidonk)
    Uva.CRW<-read.csv("B.Temperature_data/Uva_Daily_CRW_5km_1985-2016.csv",header = T)
    Uva.CRW$Date<-as.Date(Uva.CRW$Date, format="%Y-%m-%d")
    ```
  
Compile all temperature data in wide format

```{r DataWide}
    
Temperature.Wide<-merge(Uva.OI, Uva.InSitu, on=Date, all=TRUE)
Temperature.Wide<-merge(Temperature.Wide, Uva.CRW, on=Date, all=TRUE)

```

Compile all temperature data in tall format

```{r DataTall}

#OISST
    Uva.OI.L<-Uva.OI
    Uva.OI.L$Source<-"OI_SST"
    colnames(Uva.OI.L) <- c("Date","Temperature","Source")

#InSitu
    Uva.InSitu.L<-Uva.InSitu
    Uva.InSitu.L$source<-"In_situ"
    colnames(Uva.InSitu.L) <- c("Date","Temperature", "Source")
    
# CRW-5km SST
      Uva.CRW.L<-Uva.CRW
      Uva.CRW.L$Source<-"CRW_SST"
      colnames(Uva.CRW.L) <- c("Date", "Temperature", "Source")
      
Temperature.Tall<-rbind(Uva.OI.L, Uva.InSitu.L, Uva.CRW.L)      
      
```

# 2. Climatology and MMM

## 2.1 OI MMM

Calculate the mean SST per month-year, the monthly mean and then obtain the maximum monthly mean (MMM) using data OISST from 1985-2012.

```{r OISST_MMM}

# Extract months and years from date
  Uva.OI$Month<-month(Uva.OI$Date)
  Uva.OI$Year<-year(Uva.OI$Date)

# Select data from 1985-2012
  Uva.OI.1985_2012<-filter(Uva.OI, Year>1984)
  Uva.OI.1985_2012<-filter(Uva.OI.1985_2012, Year<2013)

# Calculate month-year mean SST
  Uva.OI.MM_1985_2012<-Uva.OI.1985_2012 %>%
    group_by(Month, Year) %>%
    summarize(MM = mean(OISST, na.rm = TRUE))

# Calculate monthly mean SST
  Uva.OI.MonthlyClimatology_1985_2012<-Uva.OI.MM_1985_2012 %>%
    group_by(Month) %>%
    summarize(Clima_M = mean(MM, na.rm = TRUE))
  Uva.OI.MonthlyClimatology_1985_2012

# Get maximum monthly mean (MMM)
  MMM_OI<-max(Uva.OI.MonthlyClimatology_1985_2012$Clima_M)
  MMM_OI

```


## 2.2 CRW MMM

Import the MMM from CRW 5km suit products

```{r CRW_MMM}

# Calculated MMM
# # Extract months and years from date
#   Uva.CRW$Year<-year(Uva.CRW$Date)   
#   Uva.CRW$Month<-month(Uva.CRW$Date)   
# 
# # Calculate month-year mean SST
#   Uva.CRW.MM<-Uva.CRW %>%
#     group_by(Month, Year) %>%
#     summarize(M_Temeprature = mean(Temperature, na.rm = TRUE))
# 
# # Calculate monthly mean SST             
#   Uva.CRW.MonthlyClimatology<-Uva.CRW.MM %>%
#     group_by(Month) %>%
#     summarize(Clima_M = mean(M_Temeprature, na.rm = TRUE))
#   Uva.CRW.MonthlyClimatology
#   
# # Get maximum monthly mean (MMM)              
#   MMM_CRW<-max(Uva.CRW.MonthlyClimatology$Clima_M)
#   MMM_CRW

# Get maximum monthly mean (MMM) from CRW 5km products
  Uva.CRW.MMM<-read.csv("B.Temperature_data/Uva_CRW_MMM_1985-2012.csv", header = T)
  
  MMM_CRW<-Uva.CRW.MMM[1,1]
  MMM_CRW
```

## 2.3 In Situ MMM

This code uses in situ available data collected by Tyler Smith et al and calculates an approximated In Situ climatology (~1997-2018, with gaps). The time frame used in this climatology differs from the CWR and OI climatologies. We decided to use all the data available since data were scarcer. 


```{r InSitu_MMM}
# Extract months and years from date
  Uva.InSitu$Year<-year(Uva.InSitu$Date)   
  Uva.InSitu$Month<-month(Uva.InSitu$Date)   

# Calculate month-year mean SST
  Uva.InSitu.MM<-Uva.InSitu %>%
    group_by(Month, Year) %>%
    summarize(M_Temeprature = mean(Temperature, na.rm = TRUE))

# Calculate monthly mean SST             
  Uva.InSitu.MonthlyClimatology<-Uva.InSitu.MM %>%
    group_by(Month) %>%
    summarize(Clima_M = mean(M_Temeprature, na.rm = TRUE))
  Uva.InSitu.MonthlyClimatology
  
# Get maximum monthly mean (MMM)              
  MMM_InSitu<-max(Uva.InSitu.MonthlyClimatology$Clima_M)
  MMM_InSitu
```

Notes about MMMs

* Values: CRW MMM (28.9 C) < Insitu MMM (29.05983 C) < OI MMM (29.16445 C)
* Observations: Insitu MMM (n=7,864 days) < CRW MMM (n=10,227) = OI MMM (n=10,227)
* Time frame: Insitu MMM (1997-2018, with gaps) < CRW MMM (1985-2012) = OI MMM (1985-2012)

Calculated CRW MMM is higher (29.09882 C) than MMM extracted directly from the 5km products (28.9 C), (ftp://ftp.star.nesdis.noaa.gov/pub/sod/mecb/crw/data/5km/v3.1/climatology/nc/ct5km_climatology_v3.1.nc). 

https://coralreefwatch.noaa.gov/satellite/bleaching5km/index.php says: This 28-year climatology covers the time period 1985-2012 and is based on the daily global 5km 'CoralTemp' SST data product. This 5km climatology was re-centered to the time-center of the operational 50km climatology (1985-1990 plus 1993) to maintain consistency with the former Version 2 5km climatology and CRW's heritage 50km products. Not really sure how the data are "re-centered", but this seems to lower the MMM. 

# 3. DHW 

## 3.1 OISST DHW calculation

This code uses a mixed approach (Ruben van Hooidonk + CRW) to estimate DHW, based on OI_SST data:

* SST data source is OI_SST v2, not CRW (CoralTemp). OI data were initially preferred because CRW data start in 1985 and missed the 1982-83 ENSO
* MMM values used are the calculated above, based on OI_SST_v2 SST from the period 1985-2012. This is the same period used for the CRW_5KM_V3_climatology.
* OISST has one temperature value per day, there is no distinction between day/night SST as there is in CRW products
* HotSpots are calculated daily, then divided by 7 to calculate DHW from DHDays

```{r OISST_DHW_MMM_29.16445}

##### Calculate IO DHW
      Uva.OI.L$HotSpot<-(Uva.OI.L$Temperature-(MMM_OI))
      Uva.OI.L$HotSpot<-ifelse(Uva.OI.L$HotSpot>=0,
                              Uva.OI.L$HotSpot, 0)# REMOVE NEGATIVE ANOMALIES
      Uva.OI.L$Stress<-ifelse(Uva.OI.L$HotSpot>=1,
                              Uva.OI.L$HotSpot, 0) # REMOVE HotSpot lower than 1
      Uva.OI.L$W_Stress<-(Uva.OI.L$Stress/7) # DHDays to DHWeeks
      Uva.OI.L$DHW<-rollapplyr(Uva.OI.L$W_Stress,list(-(83:0)),sum,fill=NA)# Add 12 weeks of heat stress data 
```

## 3.2 CRW SST DHW calculation

This code uses CRW MMM and CRW SST data to estimate DHW:

* MMM values used were extracted from the CWR 5km climatology that includes 1985-2012 data. Calculated MMM value is slightly different (warmer) than MMM value extracted from CRW_5KM_V3_climatology.

```{r CRWSST_DHW_MMM_28.9}

##### Calculate CRW DHW based on CRW MMM
      Uva.CRW.L$HotSpot<-(Uva.CRW.L$Temperature-(MMM_CRW))
      Uva.CRW.L$HotSpot<-ifelse(Uva.CRW.L$HotSpot>=0,
                              Uva.CRW.L$HotSpot, 0)# REMOVE NEGATIVE ANOMALIES
      Uva.CRW.L$Stress<-ifelse(Uva.CRW.L$HotSpot>=1,
                              Uva.CRW.L$HotSpot, 0) # REMOVE HotSpot lower than 1
      Uva.CRW.L$W_Stress<-(Uva.CRW.L$Stress/7) # DHDays to DHWeeks
      Uva.CRW.L$DHW<-rollapplyr(Uva.CRW.L$W_Stress,list(-(83:0)),sum,fill=NA)# Add 12 weeks of heat stress data 

```

## 3.3 InSitu DHW calculation

This code uses a mixed approach (Ruben van Hooidonk + CRW) to estimate DHW, based on In situ data:

* Temperature data source are Tyler Smith's Hobo temps, not CRW SST.
* MMM values used are the calculated above, based HOBOs' data from the period ~ 1997-2018. This is a different period than the one used for the CRW_5KM_V3_climatology, but it is the range available. The data present gaps
* Daily mean temperatures were calculated using all the data available for a day (day + night)
* HotSpots are calculated daily, then divided by 7 to calculate DHW from DHDays


```{r InSitu_DHW_MMM_29.06}
##### Calculate IO DHW
      Uva.InSitu.L$HotSpot<-(Uva.InSitu.L$Temperature-(MMM_InSitu))
      Uva.InSitu.L$HotSpot<-ifelse(Uva.InSitu.L$HotSpot>=0,
                              Uva.InSitu.L$HotSpot, 0)# REMOVE NEGATIVE ANOMALIES
      Uva.InSitu.L$Stress<-ifelse(Uva.InSitu.L$HotSpot>=1, 
                              Uva.InSitu.L$HotSpot, 0) # Select HotSpots >=1
      Uva.InSitu.L$W_DHW<-(Uva.InSitu.L$Stress/7)
      Uva.InSitu.L$DHW<-rollapplyr(Uva.InSitu.L$W_DHW,list(-(83:0)),sum,fill=NA)
     
```

# 4. DHW plots

## 4.1 Explore available data based on all data sources

```{r DHW_All}
# Wide DHW 
    DHW.InSitu.W<-Uva.InSitu.L[, c("Date","DHW")]
    colnames(DHW.InSitu.W) <- c("Date","InSitu_DHW")
    
    DHW.CRW.W<-Uva.CRW.L[, c("Date","DHW")]
    colnames(DHW.CRW.W) <- c("Date","CRW_DHW")
    
    DHW.OI.W<-Uva.OI.L[, c("Date", "DHW")]
    colnames(DHW.OI.W) <- c("Date","OI_DHW")
    
    DHW.Wide<-merge(DHW.InSitu.W, DHW.CRW.W, on=Date, all=TRUE)
    DHW.Wide<-merge(DHW.Wide, DHW.OI.W, on=Date, all=TRUE)
  
# Long DHW data
    Uva.InSitu.DHW<-Uva.InSitu.L[, c("Source", "Date", "Temperature", "HotSpot", "DHW")]
    Uva.CRW.DHW<-Uva.CRW.L[, c("Source", "Date", "Temperature",  "HotSpot", "DHW")]
    Uva.OI.DHW<-Uva.OI.L[, c("Source", "Date", "Temperature",  "HotSpot", "DHW")]

    Long.data.DHW<-rbind(Uva.InSitu.DHW,Uva.CRW.DHW,Uva.OI.DHW)
    Long.data.DHW$Source<-factor(Long.data.DHW$Source, 
                            levels = c("OI_SST","CRW_SST","In_situ"))
    Long.data.DHW$Year<-lubridate::year(Long.data.DHW$Date)
    Long.data.DHW$Month<-lubridate::month(Long.data.DHW$Date)

# Highest DWH per year
    MaxDHW<-as.data.frame(Long.data.DHW %>%
          group_by(Source, Year) %>%
          summarize(max = max(DHW, na.rm = TRUE)))
    MaxDHW<-dcast(MaxDHW, Year ~ Source, value.var = "max")
    MaxDHW

# Highest HotSpot per year
  MaxHS<-as.data.frame(Long.data.DHW %>%
        group_by(Source, Year) %>%
        summarize(max = max(HotSpot, na.rm = TRUE)))
  MaxHS<-dcast(MaxHS, Year ~ Source, value.var = "max")
  MaxHS

# Plot data
AllSources<-ggplot(Long.data.DHW, aes(x=Date)) + 
    ggthe_bw+ theme(legend.position = "none")+
    facet_wrap(~Source)+
    geom_hline(yintercept=8, linetype="dashed", color="red")+
    geom_hline(yintercept=4, linetype="dashed", color="orange")+
    geom_line(aes(y = Temperature, colour = "Temperature")) +
    geom_line(aes(y = DHW, colour = "DWH")) +
    ylab("DWH (C-week)  /  Temperature (C)")
AllSources

```

## 4.2 Comparison of the 3 ENSO events based on OISST data

```{r ENSOdates}

# 1. Extract only 1982-83, 1997-98 and 2015-16 Data 

  # 1981-82
    Days<-as.data.frame(seq(1,730,by=1))
    names(Days) <- c("Days")
    
    N_1982<-as.data.frame(seq(as.Date("1982-01-01"), 
                              as.Date("1983-12-31"), by="days"))
        names(N_1982) <- c("Date")
        N_1982<-cbind(Days, N_1982)
        N_1982$Event<-"1982-83"
        tail(N_1982,n=2)
  
  # 1997-98
    N_1997<-as.data.frame(seq(as.Date("1997-01-01"), 
                              as.Date("1998-12-31"), by="days"))
        names(N_1997) <- c("Date")
        N_1997<-cbind(Days,N_1997)
        N_1997$Event<-"1997-98"
        tail(N_1997,n=2)
  
  # 2015-16  
    Days<-as.data.frame(seq(1,731,by=1)) # 2015-2016 Needs an extra day 
    names(Days) <- c("Days")
    
    N_2015<-as.data.frame(seq(as.Date("2015-01-01"), 
                              as.Date("2016-12-31"), by="days"))
        names(N_2015) <- c("Date")
        N_2015<-cbind(Days, N_2015)
        N_2015$Event<-"2015-16"
        tail(N_2015,n=2)
  
  # ENSO years
    ENSO_Dates<-rbind(N_1982, N_1997, N_2015)

Nino.OI_data<-merge(x = ENSO_Dates, y = Uva.OI.L, by = "Date", all.x = TRUE)
Nino.OI_data$Dates<-format(Nino.OI_data$Date, format= "%m-%d")
#head(Nino.OI_data,n=2)
#tail(Nino.OI_data,n=2)

```

### Figure 1a

```{r ENSOs_OI}

Figure1a<-ggplot(Nino.OI_data, aes(x=Days)) + ggtitle("a.")+ ggthe_bw+
  theme(legend.box.background = element_rect(),
        legend.position = c(0.15, 0.75)) +
  geom_hline(yintercept=8, linetype="dashed", color="red", size=1)+
  geom_hline(yintercept=4, linetype="dashed", color="orange", size=1)

Figure1a <-Figure1a +
  geom_line(aes(y = DHW, colour = factor(Event)), size=1.0) + 
  scale_x_continuous(limits = c(0,701), expand = c(0, 0), 
                     name=("Month"),
                     breaks = seq(0,701, by= 90))+
  scale_y_continuous(limits = c(0,11), 
                     name=(expression("DHW"~(degree*C ~"-weeks"))), expand = c(0.01, 0.01),
                     breaks = seq(0,10, by=2)) +  
  scale_colour_manual(values = c("magenta","cyan", "black"), name="ENSO")
Figure1a
#ggsave(file="C.Outputs/Figure_1a.svg", plot=Figure1a, width=6.5, height=3.5)

```

```{r}

Figure1a2 <-Figure1a +
  geom_line(aes(y = DHW), size=1.0) + 
  scale_x_continuous(limits = c(0,701), expand = c(0, 0), 
                     name=("Month"),
                     breaks = seq(0,701, by= 90))+
  scale_y_continuous(limits = c(0,11), 
                     name=(expression("DHW"~(degree*C ~"-weeks"))), expand = c(0.01, 0.01),
                     breaks = seq(0,10, by=2)) +  
  facet_grid(~Event)
Figure1a2
#ggsave(file="C.Outputs/Figure_1a2.svg", plot=Figure1a2, width=7, height=4)
```


**Figure 1a**: Accumulated heat stress and thermal regime at Uva Island, Gulf of Chiriquí. **a.** Degree heating weeks (DHW) during the 1982-83, 1997-98 and 2015-16 ENSOs estimated using daily OISST data. The yellow dashed line marks the 4 DHW threshold for significant likelihood of bleaching, and the red dashed line marks 8 DHW threshold for significant likelihood of mortality. </br> 

## 4.3 Temperature and DHW during 2015-16 ENSO events based on OI and InSitu data

### Figure 2a
```{r 2015_16ENSO_OI}
 # Figure 1b

TemperaturePlot<-ggplot(Temperature.Wide, aes(x=Date)) + ggthe_bw+
    theme(legend.position = "none") +
    scale_colour_manual(values = c("gray", "black"), name="Source")
    #scale_colour_manual(values = c("black", "blue4","grey"), name="Source")

TemperaturePlot<-TemperaturePlot + 
  geom_hline(yintercept=MMM_OI+1, linetype="dashed", color="black")+
  geom_hline(yintercept=MMM_InSitu+1, linetype="dashed", color="grey")+
  #geom_hline(yintercept=MMM_CRW+1, linetype="dashed", color="blue4")+
  geom_line(aes(y = (OISST), colour = "OI_SST"), linetype=1, size=0.3, alpha=0.9) +      
  geom_line(aes(y = (Temperature), colour = "In situ"), size=0.4, alpha=0.9) +
  #geom_line(aes(y = (CRWSST), colour = "CRW_SST"), linetype=1, size=0.3, alpha=0.9) +
  
  scale_x_date(date_breaks = "3 months", date_labels = "%y-%m", 
               limits = c(as.Date("2014-07-15"), as.Date("2016-07-10")),
               name = "") +
  scale_y_continuous(limits = c(26,31.1), expand = c(0.01, 0), 
                   name=(expression("Temperature"~(degree*C))),
                   breaks = seq(26,31, by=1))+
  annotate("rect", xmin= as.Date("2014-08-17"), xmax = as.Date("2014-08-24"), 
                 ymin = 26, ymax = 31, fill="blue", alpha = .3) +
  annotate("rect", xmin= as.Date("2015-08-16"), xmax = as.Date("2015-08-22"), 
                 ymin = 26, ymax = 31, fill="blue", alpha = .3) + 
  annotate("rect", xmin= as.Date("2016-04-16"), xmax = as.Date("2016-04-21"), 
                 ymin = 26, ymax = 31, fill="blue", alpha = .3)
  
DHWPlot<-ggplot(DHW.Wide, aes(x=Date)) + ggthe_bw+
   theme(legend.box.background = element_rect(),
        legend.position = c(0.2, 0.4)) +
  scale_colour_manual(values = c("gray", "black"), name="Data source")
  #scale_colour_manual(values = c("blue4", "gray","black"), name="Source")
DHWPlot<-DHWPlot +
    geom_hline(yintercept=8, linetype="dashed", color="red", size=0.5)+
    geom_hline(yintercept=4, linetype="dashed", color="orange", size=0.5)+
    geom_line(aes(y = (OI_DHW), colour = "OI SST"), linetype=1, size=0.3, alpha=0.9) +      
    geom_line(aes(y = (InSitu_DHW), colour = "In situ"), size=0.4, alpha=0.9) +
    #geom_line(aes(y = (CRW_DHW), colour = "CRW"), size=0.4, alpha=0.9) +  
    scale_x_date(date_breaks = "3 months", date_labels = "%m/%Y", 
               limits = c(as.Date("2014-07-15"), as.Date("2016-07-10")),
               name = "Month-Year") +
    scale_y_continuous(limits = c(0,10), expand = c(0.01, 0), 
                   name=(expression("DHW"~(degree*C~"-weeks"))),
                   breaks = seq(0,10, by=2))+
    annotate("rect", xmin= as.Date("2014-08-17"), xmax = as.Date("2014-08-24"), 
                 ymin = 0, ymax = 10, fill="blue", alpha = .3) +
    annotate("rect", xmin= as.Date("2015-08-16"), xmax = as.Date("2015-08-22"), 
                 ymin = 0, ymax = 10, fill="blue", alpha = .3) + 
    annotate("rect", xmin= as.Date("2016-04-16"), xmax = as.Date("2016-04-21"), 
                 ymin = 0, ymax = 10, fill="blue", alpha = .3)

Figure2a_Final<-grid.arrange(TemperaturePlot, DHWPlot, nrow=2, heights=c(6/10, 4/10))

#ggsave(file="C.Outputs/Figure_1b.svg", plot=Figure2a_Final, width=6.5, height=4.5)

```

**Figure 2**: Accumulated heat stress and thermal regime at Uva Island, Gulf of Chiriquí. **a.** Thermal regime before and during the 2015-16 El Niño using daily OISST (black) and in situ (gray) data collected at Uva Island reef (~3m depth). Upper plot and right-hand axis show mean daily temperature (solid lines) and bleaching threshold (dashed lines) for each data set. Lower plot and and left-hand axis show DHW calculated from each data source. The blue vertical lines represent the periods when the coral samples were collected. </br> 

# 5. Potential bias based on data source (Supplementary Information)

## 5.1 SST with data from 2014-2016

```{r CheckSorcesBias2014_2016Data}
  Temperature.Wide$Year<-year(Temperature.Wide$Date)
  Temperature.Wide_2014_2016<-filter(Temperature.Wide, Year>2013)
  Temperature.Wide_2014_2016<-filter(Temperature.Wide_2014_2016, Year<2017)
  summary(Temperature.Wide_2014_2016$OISST)
  summary(Temperature.Wide_2014_2016$CRWSST )
  summary(Temperature.Wide_2014_2016$Temperature)
```

### Figure S1
```{r CheckSorcesBias2014_2016_Plots, echo=FALSE}

TemperatureSource<-ggplot(Temperature.Wide_2014_2016, aes(x=Date)) + 
      ggthe_bw + ggtitle("a.") +
      scale_x_date(date_breaks = "3 months", date_labels = "%m-%Y", 
                   limits = c(as.Date("2014-08-01"), as.Date("2016-08-15")),
                   expand = c(0.005, 0.005),
                   name = "Month-Year") +
      scale_y_continuous(limits = c(26,31), expand = c(0.01, 0), 
                       name=(expression("Temperature"~(degree*C))),
                       breaks = seq(26,31, by=0.5))+
      theme(legend.box.background = element_rect(),
            legend.position = c(0.48, 0.22))+
      
      geom_line(aes(y = (OISST), colour = "OI_SST"), linetype=1, size=0.3, alpha=0.9) +      
      geom_line(aes(y = (Temperature), colour = "In situ"), size=0.4, alpha=0.9) +
      geom_line(aes(y = (CRWSST), colour = "CRW_SST"), linetype=1, size=0.3, alpha=0.9) +
      geom_hline(yintercept=MMM_OI+1, linetype="dashed", color="black")+
      geom_hline(yintercept=MMM_InSitu+1, linetype="dashed", color="grey")+
      geom_hline(yintercept=MMM_CRW+1, linetype="dashed", color="blue")+
      scale_colour_manual(values = c("blue4","grey","black"), name=" Data source")

#TemperatureSource
#ggsave(file="Outputs/Sup_TemperatureSource.svg", plot=TemperatureSource, width=8, height=3.5)


# b. OI versus In situ 

  LM_OI<-lm(OISST~Temperature, data = Temperature.Wide_2014_2016)
  summary(LM_OI)
      
  GCITYvsOI<-ggplot(Temperature.Wide_2014_2016, aes(x=Temperature, y=OISST)) + 
        ggthe_bw + ggtitle("b.")+
        
        geom_abline(slope = 1, intercept = 0, colour="grey")+
        geom_point(alpha=0.1, size=0.08)+ 
        geom_smooth(method = lm, colour="black")+
        geom_hline(yintercept=MMM_OI+1, linetype="dashed", color="black")+
        geom_vline(xintercept=MMM_InSitu+1, linetype="dashed", color="black")+
    
        scale_y_continuous(limits = c(26,31.5), expand = c(0.01, 0), 
                         name=(expression("OISST"~(degree*C))),
                         breaks = seq(26,32, by=1))+
        scale_x_continuous(limits = c(26,31.5), expand = c(0.01, 0), 
                         name=(expression("In situ temperature"~(degree*C))),
                         breaks = seq(26,32, by=1))+
        annotate("text", x = 28, y = 31, label = "OISST = 0.8 In situ + 6.9 \n R2: 0.67")+
        
        annotate("text", x = c(29.5, 30.5, 29.5, 30.5), y = c(29.5, 30.5, 30.5, 29.5), label = c("I", "II", "III", "IV"))
  #GCITYvsOI
  # ggsave(file="Outputs/LM_OI.svg", plot=GCITYvsOI, width=4, height=3.5)



# c. CRW versus In situ 

  LM_CRW<-lm(CRWSST~Temperature, data = Temperature.Wide_2014_2016)
  summary(LM_CRW)
      
  GCITYvsCRW<-ggplot(Temperature.Wide_2014_2016, aes(x=Temperature, y=CRWSST)) + 
        ggthe_bw+ ggtitle("c.")+
    
        geom_abline(slope = 1, intercept = 0, colour="grey")+
        geom_point(alpha=0.1, size=0.05)+ 
        geom_smooth(method = lm, colour="blue4")+
        geom_hline(yintercept=MMM_CRW+1, linetype="dashed", color="black")+
        geom_vline(xintercept=MMM_InSitu+1, linetype="dashed", color="black")+
          
        scale_y_continuous(limits = c(26,31.5), expand = c(0.01, 0), 
                         name=(expression("CRW"~(degree*C))),
                         breaks = seq(26,32, by=1))+
        scale_x_continuous(limits = c(26,31.5), expand = c(0.01, 0), 
                         name=(expression("In situ temperature"~(degree*C))),
                         breaks = seq(26,32, by=1))+
    
        annotate("text", x = 28, y = 31, label = "CRW = 0.6 In situ + 10.4 \n R2: 0.58")+
        annotate("text", x = c(29.5, 30.5, 29.5, 30.5), y = c(29.5, 30.5, 30.5, 29.5), label = c("I", "II", "III", "IV"))
  #GCITYvsCRW
  #ggsave(file="Outputs/LM_CRW.svg", plot=GCITYvsCRW, width=4, height=3.5)


# d. OI differences 
      
 Temperature.Wide_2014_2016$OI_Difference<-
  (Temperature.Wide_2014_2016$OISST-Temperature.Wide_2014_2016$Temperature)
    
 OIResiduals<-ggplot(Temperature.Wide_2014_2016, aes(x=Temperature, y=OI_Difference)) + 
      ggthe_bw+ ggtitle("d.")+
      
      geom_abline(slope = 0, intercept = 0, colour="grey")+ ggtitle("d.")+
      geom_point(alpha=0.1, size=0.05)+ 
      geom_smooth(method = lm, colour="black")+
      
      scale_y_continuous(limits = c(-3,3), expand = c(0, 0), 
                         name=(expression("OI difference"~(degree*C))),
                         breaks = seq(-3,3, by=0.5))+
      scale_x_continuous(limits = c(26,31.5), expand = c(0.01, 0), 
                         name=(expression("In situ Temperature"~(degree*C))),
                         breaks = seq(26,32, by=1))
    #OIResiduals
    #ggsave(file="Outputs/OI_Differences.svg", plot=OIResiduals, width=4, height=3.5)

# e. CRW differences 
      
Temperature.Wide_2014_2016$CRW_Difference<-
  (Temperature.Wide_2014_2016$CRWSST-Temperature.Wide_2014_2016$Temperature)
    
  CRWResiduals<-ggplot(Temperature.Wide_2014_2016, aes(x=Temperature, y=CRW_Difference)) + 
      ggthe_bw+ ggtitle("e.")+
      geom_abline(slope = 0, intercept = 0, colour="grey")+
      geom_point(alpha=0.1, size=0.05)+ 
      geom_smooth(method = lm, colour="blue4")+
    
    scale_y_continuous(limits = c(-3,3), expand = c(0, 0), 
                             name=(expression("CRW difference"~(degree*C))),
                             breaks = seq(-3,3, by=0.5))+
    scale_x_continuous(limits = c(26,31.5), expand = c(0.01, 0), 
                             name=(expression("In situ Temperature"~(degree*C))),
                             breaks = seq(26,32, by=1))
    #CRWResiduals
    #ggsave(file="Outputs/OI_Differences.svg", plot=CRWResiduals, width=4, height=3.5)
  
  # f. OI HS differences 
      Temperature.Wide_2014_2016$IS_HS<-(Temperature.Wide_2014_2016$Temperature-MMM_InSitu)
      Temperature.Wide_2014_2016$IS_HS<-ifelse(Temperature.Wide_2014_2016$IS_HS>=0,
                                        Temperature.Wide_2014_2016$IS_HS, 0)# REMOVE NEGATIVE ANOMALIES
      
      Temperature.Wide_2014_2016$OI_HS<-(Temperature.Wide_2014_2016$OISST-MMM_OI)
      Temperature.Wide_2014_2016$OI_HS<-ifelse(Temperature.Wide_2014_2016$OI_HS>=0,
                                        Temperature.Wide_2014_2016$OI_HS, 0)# REMOVE NEGATIVE ANOMALIES
      
      
      Temperature.Wide_2014_2016$CRW_HS<-(Temperature.Wide_2014_2016$CRWSST-MMM_CRW)
      Temperature.Wide_2014_2016$CRW_HS<-ifelse(Temperature.Wide_2014_2016$CRW_HS>=0,
                                        Temperature.Wide_2014_2016$CRW_HS, 0)# REMOVE NEGATIVE ANOMALIES
      
 OI_HS<-ggplot(Temperature.Wide_2014_2016, aes(x=IS_HS, y=OI_HS)) + 
      ggthe_bw+ ggtitle("f.")+
      
      geom_abline(slope = 1, intercept = 0, colour="grey")+ ggtitle("d.")+
      geom_point(alpha=0.1, size=0.3)+ 
      geom_smooth(method = lm, colour="black")+
      
      scale_y_continuous(limits = c(0,2), expand = c(0.01, 0), 
                         name=(expression("OI HS"~(degree*C))),
                         breaks = seq(0,2, by=0.5))+
      scale_x_continuous(limits = c(0,2), expand = c(0.01, 0), 
                         name=(expression("In situ HS"~(degree*C))),
                         breaks = seq(0,2, by=0.5))
    #OI_HS
   
# g. CRW HS differences 
      
 CRW_HS<-ggplot(Temperature.Wide_2014_2016, aes(x=IS_HS, y=CRW_HS)) + 
      ggthe_bw+ ggtitle("g.")+
      
      geom_abline(slope = 1, intercept = 0, colour="grey")+ ggtitle("d.")+
      geom_point(alpha=0.1, size=0.3)+ 
      geom_smooth(method = lm, colour="black")+
      
      scale_y_continuous(limits = c(0,2), expand = c(0.01, 0), 
                         name=(expression("CRW HS"~(degree*C))),
                         breaks = seq(0,2, by=0.5))+
      scale_x_continuous(limits = c(0,2), expand = c(0.01, 0), 
                         name=(expression("In situ HS"~(degree*C))),
                         breaks = seq(0,2, by=0.5))
    #CRW_HS
   
  
  # h. Differences overtime 
      
     TemperatureSource2<-ggplot(Temperature.Wide_2014_2016, aes(x=Date)) + 
          theme_bw() + ggtitle("f.") + geom_abline(slope = 0, intercept = 0)+
          scale_x_date(date_breaks = "3 months", date_labels = "%m-%Y", 
                       limits = c(as.Date("2014-08-01"), as.Date("2016-08-15")),
                       expand = c(0.005, 0.005),
                       name = "Month-Year") +
          scale_y_continuous(limits = c(-3.5,3), expand = c(0.01, 0), 
                          name=(expression("Difference Temperature"~(degree*C))),
                           breaks = seq(-3,3, by=0.5))+
          theme(plot.background=element_blank(),
                panel.grid.major.y = element_blank(),
                panel.grid.major.x = element_blank(),
                panel.grid.minor.x = element_blank(),
                panel.grid.minor.y = element_blank(),
                legend.box.background = element_rect(),
                legend.position = c(0.48, 0.22),
                panel.background =element_rect(fill = NA, color = "black"))+
          
          geom_line(aes(y = (OI_Difference), colour = "OISST"), linetype=1, size=0.3, alpha=0.9) +      
          geom_line(aes(y = (CRW_Difference), colour = "CRW_5km"), size=0.4, alpha=0.9) +
          scale_colour_manual(values = c("blue4","grey"), name=" Data source")
       #TemperatureSource2


Sources<-grid.arrange(
  TemperatureSource, arrangeGrob(GCITYvsOI,GCITYvsCRW, ncol=2), heights=c(5/10, 5/10), ncol = 1)

# ggsave(file="C.Outputs/Figure_S1.svg", plot=Sources, width=7, height=7)

```

**Supplementary Figure S1:** Temperature comparison among different data sources. **a.** Temperature for the August 2014 - August 2016 period. **b.** Correlation between OISST (v2) data and *in situ* (3m) data. **c.** Correlation between CRW (CoralTemp v3.1) and *in situ* data. Panels I contain SST values under the bleaching threshold for both data sets being compared (there is not accumulation of DHW). Panels II contain SST values above the bleaching threshold for both data sets being compared (both data sets accumulate of DHW). Panels III contain the cases in which satellite values were above the bleaching threshold, both not the *in situ* values (potential DHW overestimation). Panels IV contain the cases in which *in situ* values were above the bleaching threshold, both not the satellite values (potential DHW underestimation). </br> 

## 5.2 SST with all data from any year with the 3 sources

```{r CheckSourcesBiasAll}
  Temperature.Wide.All<-Temperature.Wide[complete.cases(Temperature.Wide), ]
  
```

```{r CheckSourcesBiasall_Plots, echo=FALSE}

TemperatureSource2<-ggplot(Temperature.Wide, aes(x=Date)) + 
      ggthe_bw + ggtitle("a.") +
      scale_x_date(date_breaks = "12 months", date_labels = "%y", 
                   limits = c(as.Date("1985-01-01"), as.Date("2016-12-31")),
                   expand = c(0.005, 0.005),
                   name = "Year") +
      scale_y_continuous(limits = c(24.5,31.5), expand = c(0.01, 0), 
                       name=(expression("Temperature"~(degree*C))),
                       breaks = seq(24.5,31.5, by=0.5))+
      theme(legend.box.background = element_rect(),
            legend.position = c(0.48, 0.22))+
      
      geom_line(aes(y = (OISST), colour = "OI_SST"), linetype=1, size=0.2, alpha=0.8) +      
      geom_line(aes(y = (Temperature), colour = "In situ"), size=0.2, alpha=0.8) +
      geom_line(aes(y = (CRWSST), colour = "CRW_SST"), linetype=1, size=0.2, alpha=0.8) +
      geom_hline(yintercept=MMM_OI+1, linetype="dashed", color="black")+
      geom_hline(yintercept=MMM_InSitu+1, linetype="dashed", color="grey")+
      geom_hline(yintercept=MMM_CRW+1, linetype="dashed", color="blue")+
      scale_colour_manual(values = c("blue4","grey","black"), name=" Data source")
# TemperatureSource2

# b. OI versus In situ 

  LM_OI2<-lm(OISST~Temperature, data = Temperature.Wide)
  summary(LM_OI2)
      
  GCITYvsOI2<-ggplot(Temperature.Wide, aes(x=Temperature, y=OISST)) + 
        ggthe_bw + ggtitle("b.")+
        
        geom_abline(slope = 1, intercept = 0, colour="grey")+
        geom_point(alpha=0.1, size=0.05)+ 
        geom_smooth(method = lm, colour="black")+
        geom_hline(yintercept=MMM_OI+1, linetype="dashed", color="black")+
        geom_vline(xintercept=MMM_InSitu+1, linetype="dashed", color="black")+
    
        scale_y_continuous(limits = c(25,31.5), expand = c(0.01, 0), 
                         name=(expression("OISST"~(degree*C))),
                         breaks = seq(25,32, by=1))+
        scale_x_continuous(limits = c(25,31.5), expand = c(0.01, 0), 
                         name=(expression("In situ temperature"~(degree*C))),
                         breaks = seq(25,32, by=1))+
        annotate("text", x = 28, y = 31, label = "OISST = 0.8 In situ + 5.8 \n R2: 0.58") +
        annotate("text", x = c(29.5, 30.5, 29.5, 30.5), y = c(29.5, 30.5, 30.5, 29.5), label = c("I", "II", "III", "IV"))
  #GCITYvsOI2
  
# c. CRW versus In situ 

  LM_CRW2<-lm(CRWSST~Temperature, data = Temperature.Wide)
  summary(LM_CRW2)
      
  GCITYvsCRW2<-ggplot(Temperature.Wide, aes(x=Temperature, y=CRWSST)) + 
        ggthe_bw + ggtitle("c.")+
        
        geom_abline(slope = 1, intercept = 0, colour="grey")+
        geom_point(alpha=0.1, size=0.05)+ 
        geom_smooth(method = lm, colour="blue4")+
        geom_hline(yintercept=MMM_CRW+1, linetype="dashed", color="black")+
        geom_vline(xintercept=MMM_InSitu+1, linetype="dashed", color="black")+
    
        scale_y_continuous(limits = c(25,31.5), expand = c(0.01, 0), 
                         name=(expression("CRW"~(degree*C))),
                         breaks = seq(25,32, by=1))+
        scale_x_continuous(limits = c(25,31.5), expand = c(0.01, 0), 
                         name=(expression("In situ temperature"~(degree*C))),
                         breaks = seq(25,32, by=1))+
        annotate("text", x = 28, y = 31, label = "CRW = 0.7 In situ + 7.9 \n R2: 0.67")+
        annotate("text", x = c(29.5, 30.5, 29.5, 30.5), y = c(29.5, 30.5, 30.5, 29.5), label = c("I", "II", "III", "IV"))
  # GCITYvsCRW2


# d. OI differences 
      
     Temperature.Wide$OI_Difference<-
      (Temperature.Wide$OISST-Temperature.Wide$Temperature)
        
     OIResiduals2<-ggplot(Temperature.Wide, aes(x=Temperature, y=OI_Difference)) + 
          ggthe_bw+ ggtitle("d.")+
                 
          scale_y_continuous(limits = c(-3,3), expand = c(0, 0), 
                             name=(expression("OI difference"~(degree*C))),
                             breaks = seq(-3,3, by=0.5))+
          scale_x_continuous(limits = c(25,31.5), expand = c(0.01, 0), 
                             name=(expression("In situ Temperature"~(degree*C))),
                             breaks = seq(25,32, by=1)) +
     
          geom_abline(slope = 0, intercept = 0, colour="grey")+
          geom_point(alpha=0.1, size=0.05)+ 
          geom_smooth(method = lm, colour="black")
     #OIResiduals2
            
     #ggsave(file="Outputs/OI_Differences.svg", plot=OIResiduals, width=4, height=3.5)

 
# e. OI differences 
      
    Temperature.Wide$CRW_Difference<-
      (Temperature.Wide$CRWSST-Temperature.Wide$Temperature)
        
      CRWResiduals2<-ggplot(Temperature.Wide, aes(x=Temperature, y=CRW_Difference)) + 
          ggthe_bw+ ggtitle("e.")+
        
          scale_y_continuous(limits = c(-3,3), expand = c(0, 0), 
                                 name=(expression("CRW difference"~(degree*C))),
                                 breaks = seq(-3,3, by=0.5))+
          scale_x_continuous(limits = c(25,31.5), expand = c(0.01, 0), 
                                 name=(expression("In situ Temperature"~(degree*C))),
                                 breaks = seq(25,32, by=1))+
        
          geom_abline(slope = 0, intercept = 0, colour="grey")+ ggtitle("e.")+
          geom_point(alpha=0.1, size=0.05)+ 
          geom_smooth(method = lm, colour="blue4")
          
      # CRWResiduals2


Sources2<-grid.arrange(
  TemperatureSource2, arrangeGrob(GCITYvsOI2,GCITYvsCRW2, ncol=2), heights=c(5/10, 5/10), ncol = 1)

#ggsave(file="Outputs/TemperatureSourcess2.svg", plot=Sources2, width=7, height=8)

```

## 5.3 DHW with data from 2014-2016

```{r CheckDHWSorcesBias2014_2016Data}
# Organize the data source
Wide.data.DHW<-dplyr::filter(Long.data.DHW, Year>2013)
Wide.data.DHW<-dplyr::filter(Wide.data.DHW, Year<2017)
Wide.data.DHW<-Wide.data.DHW %>% 
              dplyr::select(Source, Date, DHW)

Wide.data.DHW2<-reshape(Wide.data.DHW, 
                        idvar = "Date", timevar = "Source", direction = "wide")

#Wide.data.DHW2<-Wide.data.DHW2[complete.cases (Wide.data.DHW2),]
#head(Wide.data.DHW2)
#tail(Wide.data.DHW2)
```

### Figure S2

```{r CheckDWHSorcesBias2014_2016_Plots, echo=FALSE}

# a. Estimated DHW

    DHWSource<-ggplot(Wide.data.DHW2, aes(x=Date)) + 
       ggthe_bw + ggtitle("a.") +
        scale_x_date(date_breaks = "3 months", date_labels = "%m-%Y", 
                    limits = c(as.Date("2014-11-08"), as.Date("2016-09-15")),
                    expand = c(0.01, 0), 
                    name = "Month-Year") +
      scale_y_continuous(limits = c(0,9), expand = c(0.01, 0), 
                         name=(expression("DHW"~(degree*C~-"weeks"))),
                         breaks = seq(0,9, by=2))+
      theme(legend.box.background = element_rect(),
            legend.position = c(0.15, 0.7))+
      
      geom_line(aes(y = (DHW.OI_SST), colour = "OISST"), linetype=1, size=0.3, alpha=0.9) +      
      geom_line(aes(y = (DHW.In_situ), colour = "In situ"), size=0.4, alpha=0.9) +
      geom_line(aes(y = (DHW.CRW_SST), colour = "CRW"), linetype=1, size=0.3, alpha=0.9) +
      scale_colour_manual(values = c("blue4","grey","black"), name=" Data source")
    #DHWSource
    #ggsave(file="Outputs/Sup_DHW.Source.svg", plot=DHWSource, width=8, height=3.5)


# b. OI versus In situ 

    LM_OI_DWW<-lm(DHW.OI_SST~DHW.In_situ, data = Wide.data.DHW2)
    summary(LM_OI_DWW)
    
    GCITYvsOI_DHW<-ggplot(Wide.data.DHW2, aes(x=DHW.In_situ, y=DHW.OI_SST)) + 
      ggthe_bw + ggtitle("b.")+
      
      geom_abline(slope = 1, intercept = 0, colour="grey")+
      geom_point(alpha=0.5, size=1)+ 
      geom_smooth(method = lm, colour="black")+
      
      scale_y_continuous(limits = c(0,9), expand = c(0.01, 0), 
                         name=(expression("OISST DHW"~(degree*C~-weeks))),
                         breaks = seq(0,9, by=1))+
      scale_x_continuous(limits = c(0,9), expand = c(0.01, 0), 
                         name=(expression("In situ DHW"~(degree*C~-weeks))),
                         breaks = seq(0,9, by=1))+
     
      annotate("text", x = 4.2, y = 8.2, label = "OISST_DHW = 0.9 (In situ_DHW) - 0.4 \n R2: 0.9")
    #GCITYvsOI_DHW
    # ggsave(file="Outputs/DWH_IS_OI.svg", plot=GCITYvsOI, width=4, height=3.5)


# c. CRW versus In situ 

    LM_CRW_DHW<-lm(DHW.CRW_SST~DHW.In_situ, data = Wide.data.DHW2)
    summary(LM_CRW_DHW)
    
    GCITYvsCRW_DHW<-ggplot(Wide.data.DHW2, aes(x=DHW.In_situ, y=DHW.CRW_SST)) + 
      ggthe_bw + ggtitle("c.")+
      
      geom_abline(slope = 1, intercept = 0, colour="grey")+ 
      geom_point(alpha=0.5, size=1)+ 
      geom_smooth(method = lm, colour="blue4")+
      
      scale_y_continuous(limits = c(0,9), expand = c(0.01, 0), 
                         name=(expression("CRW DHW"~(degree*C~-weeks))),
                         breaks = seq(0,10, by=1))+
      scale_x_continuous(limits = c(0,9), expand = c(0.01, 0), 
                         name=(expression("In situ DHW "~(degree*C~-weeks))),
                         breaks = seq(0,10, by=1))+
      annotate("text", x = 4.2, y = 8.2, label = "CRW_DHW = 0.4 (In situ_DHW) + 0.1 \n R2: 0.4")
    #GCITYvsCRW_DHW
    #ggsave(file="Outputs/DWH_IS_CRW.svg", plot=GCITYvsCRW_DHW, width=4, height=3.5)


# d. OI differences 

    Wide.data.DHW2$OI_Difference<-
      (Wide.data.DHW2$DHW.OI_SST-Wide.data.DHW2$DHW.In_situ)
    
    OI_DWH_Residuals<-ggplot(Wide.data.DHW2, aes(x=DHW.In_situ, y=OI_Difference)) + 
      ggthe_bw+ ggtitle("d.") +
      
      geom_abline(slope = 0, intercept = 0, colour="grey") +
      geom_point(alpha=0.5, size=1)+ 
      geom_smooth(method = lm, colour="black")+
      
      scale_y_continuous(limits = c(-3,3), expand = c(0, 0), 
                         name=(expression("OI difference"~(degree*C~-weeks))),
                         breaks = seq(-3,3, by=0.5))+
      scale_x_continuous(limits = c(0,9), expand = c(0.01, 0), 
                         name=(expression("In situ DHW"~(degree*C~-weeks))),
                         breaks = seq(0,10, by=1))
    #OI_DWH_Residuals
    #ggsave(file="Outputs/OI_DHW_Differences.svg", plot=OI_DWH_Residuals, width=4, height=3.5)

    
# e. OI differences 

    Wide.data.DHW2$CRW_Difference<-
      (Wide.data.DHW2$DHW.CRW_SST-Wide.data.DHW2$DHW.In_situ)
    
    CRW_DWH_Residuals<-ggplot(Wide.data.DHW2, aes(x=DHW.In_situ, y=CRW_Difference)) + 
      ggthe_bw + ggtitle("e.") +
      
      geom_abline(slope = 0, intercept = 0, colour="grey")+ 
      geom_point(alpha=0.5, size=1)+ 
      geom_smooth(method = lm, colour="blue4")+
      
      scale_y_continuous(limits = c(-3,3), expand = c(0, 0), 
                         name=(expression("CRW difference"~(degree*C))),
                         breaks = seq(-3,3, by=0.5))+
      scale_x_continuous(limits = c(0,9), expand = c(0.01, 0), 
                         name=(expression("In situ"~(degree*C))),
                         breaks = seq(0,10, by=1))
    #CRW_DWH_Residuals
    #ggsave(file="Outputs/CRW_DHW_Differences.svg", plot=CRW_DWH_Residuals, width=4, height=3.5)


Sources3<-grid.arrange(
  DHWSource, arrangeGrob(GCITYvsOI_DHW,GCITYvsCRW_DHW, ncol=2), heights=c(5/10, 5/10), ncol = 1)

#ggsave(file="C.Outputs/Figure_S2.svg", plot=Sources3, width=7, height=7)
```

**Supplementary Figure S2:** Degree heating weeks (DHW) index comparison among different data sources. **a.** DHW calculated for November 2014 - August 2016. **b.** Correlation between OISST derived in situ derived DHW indices. **c.** Correlation between CRW (CoralTemp v3.1) derived and in situ derived DHW indices. </br> 

## 5.4 DHW with all DHW data available for all 3 sources

```{r}

# Organize the data source

  Wide.data.DHW<-Long.data.DHW %>% 
                dplyr::select(Source, Date, DHW)
  
  Wide.data.DHW3<-reshape(Wide.data.DHW, 
                          idvar = "Date", timevar = "Source", direction = "wide")
  
  # Wide.data.DHW2<-Wide.data.DHW2[complete.cases (Wide.data.DHW2),]
  #head(Wide.data.DHW2)
  #tail(Wide.data.DHW2)
  
```

```{r}

# a. Estimated DHW

    DHWSource2<-ggplot(Wide.data.DHW3, aes(x=Date)) + 
       ggthe_bw + ggtitle("a.") +
       scale_x_date(date_breaks = "24 months", date_labels = "%Y", 
                    limits = c(as.Date("1997-01-01"), as.Date("2016-12-31")),
                    expand = c(0.01, 0), 
                    name = "Month-Year") +
      scale_y_continuous(limits = c(0,11), expand = c(0.01, 0), 
                         name=(expression("DHW"~(degree*C~-"weeks"))),
                         breaks = seq(0,10, by=2))+
      theme(legend.box.background = element_rect(),
            legend.position = c(0.25, 0.7))+
      
      geom_line(aes(y = (DHW.OI_SST), colour = "OISST"), linetype=1, size=0.3, alpha=0.9) +      
      geom_line(aes(y = (DHW.In_situ), colour = "In situ"), size=0.4, alpha=0.9) +
      geom_line(aes(y = (DHW.CRW_SST), colour = "CRW"), linetype=1, size=0.3, alpha=0.9) +
      scale_colour_manual(values = c("blue4","grey","black"), name=" Data source")
    #DHWSource2
    #ggsave(file="Outputs/Sup_DHW_Source2.svg", plot=DHWSource2, width=8, height=3.5)


# b. OI versus In situ 

    LM_OI_DWW2<-lm(DHW.OI_SST~DHW.In_situ, data = Wide.data.DHW3)
    summary(LM_OI_DWW2)
    
    GCITYvsOI_DHW2<-ggplot(Wide.data.DHW3, aes(x=DHW.In_situ, y=DHW.OI_SST)) + 
      ggthe_bw + ggtitle("b.")+
      
      geom_abline(slope = 1, intercept = 0, colour="grey")+
      geom_point(alpha=0.5, size=1)+ 
      geom_smooth(method = lm, colour="black")+
      
      scale_y_continuous(limits = c(0,9), expand = c(0.01, 0), 
                         name=(expression("OISST DHW"~(degree*C~-weeks))),
                         breaks = seq(0,9, by=1))+
      scale_x_continuous(limits = c(0,9), expand = c(0.01, 0), 
                         name=(expression("In situ DHW"~(degree*C~-weeks))),
                         breaks = seq(0,9, by=1))+
     
      annotate("text", x = 4.2, y = 8.2, label = "OISST_DHW = 0.8 (In situ_DHW) + 0.1 \n R2: 0.9")
    #GCITYvsOI_DHW2
    # ggsave(file="Outputs/DHW_IS_OI_2.svg", plot=GCITYvsOI_DHW2, width=4, height=3.5)


# c. CRW versus In situ 

    LM_CRW_DHW2<-lm(DHW.CRW_SST~DHW.In_situ, data = Wide.data.DHW3)
    summary(LM_CRW_DHW2)
    
    GCITYvsCRW_DHW2<-ggplot(Wide.data.DHW3, aes(x=DHW.In_situ, y=DHW.CRW_SST)) + 
      ggthe_bw + ggtitle("c.")+
      
      geom_abline(slope = 1, intercept = 0, colour="grey")+ 
      geom_point(alpha=0.5, size=1)+ 
      geom_smooth(method = lm, colour="blue4")+
      
      scale_y_continuous(limits = c(0,9), expand = c(0.01, 0), 
                         name=(expression("CRW DHW"~(degree*C~-weeks))),
                         breaks = seq(0,10, by=1))+
      scale_x_continuous(limits = c(0,9), expand = c(0.01, 0), 
                         name=(expression("In situ DHW "~(degree*C~-weeks))),
                         breaks = seq(0,10, by=1))+
      annotate("text", x = 4.2, y = 8.2, label = "CRW_DHW = 0.5 (In situ_DHW) \n R2: 0.6")
    #GCITYvsCRW_DHW2
    #ggsave(file="Outputs/DHW_IS_CRW_2.svg", plot=GCITYvsCRW_DHW2, width=4, height=3.5)


# d. OI differences 

    Wide.data.DHW3$OI_Difference<-
      (Wide.data.DHW3$DHW.OI_SST-Wide.data.DHW3$DHW.In_situ)
    
    OI_DHW_Residuals2<-ggplot(Wide.data.DHW3, aes(x=DHW.In_situ, y=OI_Difference)) + 
      ggthe_bw+ ggtitle("d.") +
      
      geom_abline(slope = 0, intercept = 0, colour="grey") +
      geom_point(alpha=0.5, size=1)+ 
      geom_smooth(method = lm, colour="black")+
      
      scale_y_continuous(limits = c(-3,3), expand = c(0, 0), 
                         name=(expression("OI difference"~(degree*C~-weeks))),
                         breaks = seq(-3,3, by=0.5))+
      scale_x_continuous(limits = c(0,9), expand = c(0.01, 0), 
                         name=(expression("In situ DHW"~(degree*C~-weeks))),
                         breaks = seq(0,10, by=1))
    #OI_DHW_Residuals2
    #ggsave(file="Outputs/DHW_OI_Differences.svg", plot=OI_DHW_Residuals2, width=4, height=3.5)

    
# e. OI differences 

    Wide.data.DHW3$CRW_Difference<-
      (Wide.data.DHW3$DHW.CRW_SST-Wide.data.DHW3$DHW.In_situ)
    
    CRW_DHW_Residuals2<-ggplot(Wide.data.DHW3, aes(x=DHW.In_situ, y=CRW_Difference)) + 
      ggthe_bw + ggtitle("e.") +
      
      geom_abline(slope = 0, intercept = 0, colour="grey")+ 
      geom_point(alpha=0.5, size=1)+ 
      geom_smooth(method = lm, colour="blue4")+
      
      scale_y_continuous(limits = c(-3,3), expand = c(0, 0), 
                         name=(expression("CRW difference"~(degree*C))),
                         breaks = seq(-3,3, by=0.5))+
      scale_x_continuous(limits = c(0,9), expand = c(0.01, 0), 
                         name=(expression("In situ"~(degree*C))),
                         breaks = seq(0,10, by=1))
    #CRW_DHW_Residuals2
    #ggsave(file="Outputs/DHW_CRW_Differences.svg", plot=CRW_DHW_Residuals2, width=4, height=3.5)


Sources4<-grid.arrange(
  DHWSource2, arrangeGrob(GCITYvsOI_DHW2,GCITYvsCRW_DHW2, ncol=2), heights=c(5/10, 5/10), ncol = 1)

#ggsave(file="Outputs/DHW_Sourcess2.svg", plot=Sources4, width=7, height=8)
```


# 6. Other ENSO characteristics (Supplementary Information)

## 6.1 HotSpots magnitude

Other way to compare ENSOs is to look at the magnitude and number of the Hot Spots

### Figure S3?

```{r Supplement3}

# Supplemantary Figure ?
  
  SupplumentFigure3a<-ggplot(Nino.OI_data, aes(x=Days)) + ggthe_bw +
      theme(legend.box.background = element_rect(),
            legend.position = "none") +
      
      geom_hline(yintercept=1, linetype="dashed", color="black")+
      geom_hline(yintercept=2, linetype="dashed", color="grey")+
      scale_x_continuous(limits = c(0,701), expand = c(0, 0), 
                         name=("Month of the year"),
                         breaks = seq(0,701, by= 90))+
      scale_y_continuous(limits = c(0,3), 
                       name=(expression("HotSpot"~(degree*C))), expand = c(0.02, 0.03),
                         breaks = seq(0,3, by=0.5))
  
  SupplumentFigure3a <-SupplumentFigure3a +
      #geom_point(aes(y = HotSpot, colour = factor(Event)), size=0.02) + 
      geom_line(aes(y = HotSpot, colour = factor(Event))) + 
     
      scale_colour_manual(values = c("magenta","cyan", "black"), name="ENSO")+
      #geom_point(aes(y = Clima_Norm, size=1)) +
      facet_grid(Event~.)
  SupplumentFigure3a
  
  #ggsave(file="C.Outputs/Figure_S3.svg", plot=SupplumentFigure3a, width=6, height=5)

```

**Supplementary Figure S3:** HotSpots (SST - MMM) at Uva Island reef during the two-year period of each El Niño calculated using NOAA OISSTv2 data. Number of HotSpots (n) have been summarized to show how many times they exceeded 2ºC (HotSpots > 2ºC, top values in each panel), were higher than 1ºC but lower or equal to 2ºC (1ºC < HotSpots ≤ 2ºC, middle values), or were lower or equal to 1ºC (0ºC < HotSpots ≤ 1ºC, bottom values). Note that only HotSpots > 1ºC are included in the estimation of DHW. Summation of all HotSpots > 1ºC during each 2 year period were 131.2 during 1982-83, 123.5 during 1997-98, and 108.7 during 2015-16. </br> 

##6.2  Number of HS higher than 0, 1, 2, and 3C, area under HS curve

```{r HS_numbers}
  
    # Number of HotSpots; HS > 1
        HS_N_1<-as.data.frame(Nino.OI_data %>%
              group_by(Event) %>%
              summarize(N = n(),
                        Cont=sum (HotSpot>=1)))
        HS_N_1
    
    # Number of HotSpots; 0<HS<1
        HS_N_0_1<-as.data.frame(Nino.OI_data %>%
              group_by(Event) %>%
              summarize(N = n(),
                        Cont=sum (HotSpot>0 & HotSpot<1)))
        HS_N_0_1
    
    # Number of HotSpots; 1<HS<2
        HS_N_1_2<-as.data.frame(Nino.OI_data %>%
              group_by(Event) %>%
              summarize(N = n(),
                        Cont=sum (HotSpot>=1 & HotSpot<2)))
        HS_N_1_2
    
    # Number of HotSpots; 2<HS<3
        HS_N_2_3<-as.data.frame(Nino.OI_data %>%
              group_by(Event) %>%
              summarize(N = n(),
                        Cont=sum (HotSpot>=2 & HotSpot<3)))
        HS_N_2_3
```

```{r Area_under_stress}

# Area under of (HS>0)
  HS_Aggregated<-as.data.frame(Nino.OI_data %>%
        group_by(Event) %>%
        summarize(Sum = sum (HotSpot)))
  HS_Aggregated

# Area under of (HS>1)
  HS1_Aggregated<-as.data.frame(Nino.OI_data %>%
        group_by(Event) %>%
        summarize(Sum = sum (HotSpot[HotSpot>1])))
  HS1_Aggregated

# Area under (HS>2)
  HS2_Aggregated<-as.data.frame(Nino.OI_data %>%
        group_by(Event) %>%
        summarize(Sum = sum (HotSpot[HotSpot>2])))
  HS2_Aggregated
```
